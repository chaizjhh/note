在SSH（Secure Shell）中，`.ssh`​ 文件夹是用于存储用户的 SSH 配置和密钥的目录。以下是该目录中常见文件的作用：

​**`authorized_keys`**​：该文件包含了授权用户登录到远程服务器的公钥列表。每个用户的公钥都应该添加到该文件中。服务器在用户尝试通过 SSH 连接时会验证这些公钥。

​**`id_rsa`**​：私钥文件，用于用户的身份验证。这是用户的私钥，不应该泄露给其他人。

​**`id_rsa.pub`**​：公钥文件，对应于 `id_rsa`​ 私钥。将该公钥添加到远程服务器的 `authorized_keys`​ 文件中，以便实现免密登录。

​**`known_hosts`**​：该文件包含已知主机的公钥信息，用于在 SSH 连接时验证远程主机的身份。每次首次连接到新主机时，其公钥将会被添加到这个文件中。

​**`config`**​：SSH 客户端的配置文件。用户可以在这里配置各种 SSH 客户端的选项，如主机别名、端口号、用户等。

​**`config.d/`** ​  **(目录)：** 该目录包含额外的 SSH 客户端配置文件。每个文件可以包含与主 SSH 配置文件相同的配置选项，但它们是可选的。

​**`id_dsa`**​  **(可能存在)：** 早期使用的 DSA（Digital Signature Algorithm）私钥文件，现在不太常见。现代系统更倾向于使用 RSA 或者更强大的算法。

​**`id_dsa.pub`**​  **(可能存在)：** DSA 公钥文件，对应于 `id_dsa`​ 私钥。同样，现代系统更常使用其他算法的密钥对。

请注意，实际使用中，这些文件的名称可能会因系统、配置或用户自定义而有所不同。上述列举的文件名是默认情况下常见的命名约定。

**SSH连接后，本机的.ssh/knows_hosts为什么会存储ssh目标机器信息**

​`known_hosts`​ 文件用于存储已知的主机密钥信息，以确保在建立 SSH 连接时能够验证远程主机的身份。当你首次通过 SSH 连接到一个远程主机时，SSH 会将该主机的公钥添加到你本地的 `known_hosts`​ 文件中。这样，下次连接相同的主机时，SSH 将会检查主机公钥是否与 `known_hosts`​ 中的记录匹配，以确保你连接的是预期的主机，而不是遭遇了中间人攻击。

在 `known_hosts`​ 文件中，每行包含一个主机的信息，通常是主机名、公钥类型和公钥本身的 Base64 编码。这些信息是通过 SSH 连接时服务器端的公钥生成的。

这个机制有助于确保你连接到的主机是你期望连接的主机，从而提供了一定的安全性。如果 `known_hosts`​ 文件中的记录与实际主机不匹配，SSH 将会发出警告，以防止潜在的安全问题。

需要注意的是，有时候当远程主机的密钥发生变化（例如重新安装操作系统），或者你连接到不同的主机时，`known_hosts`​ 文件中的记录可能会过时或不再适用。在这种情况下，SSH 会发出警告，提示你可能遇到了主机密钥的变化，以便你谨慎处理。

### SSH握手

SSH（Secure Shell）连接的握手过程主要包括以下步骤：

1. **客户端向服务器发起连接请求：** 客户端通过向服务器的22端口（SSH默认端口）发起TCP连接请求开始握手过程。
2. **版本协商：** 一旦连接建立，客户端和服务器之间会进行版本协商，以确定使用的SSH协议版本。客户端和服务器会互相发送自己支持的SSH协议版本信息。
3. **密钥交换算法协商：** 双方协商选择一组用于密钥交换和加密通信的算法。这包括密钥交换算法、加密算法、消息认证码算法等。
4. **Diffie-Hellman密钥交换：** 双方使用Diffie-Hellman密钥交换协议生成一个共享的密钥。这个密钥用于后续的对称加密通信。
5. **生成会话密钥：** 根据协商的算法，客户端和服务器分别生成用于加密通信的会话密钥。
6. **服务器身份验证：** 服务器通过向客户端发送数字签名的方式进行身份验证。客户端验证签名的有效性，确保连接的目标是预期的服务器，而不是中间人。
7. **会话通道建立：** 使用生成的会话密钥，客户端和服务器建立加密的通信通道。此后，所有的数据传输都将使用协商好的加密算法进行加密和解密。
8. **用户身份验证：** 如果需要，客户端会向服务器提供用户身份信息进行认证。这可以通过密码、公钥等方式实现。
9. **完成握手：** 一旦握手过程完成，SSH连接就建立起来了，双方可以开始进行安全的通信。

整个握手过程确保了连接的安全性，包括密钥的安全交换、服务器身份验证、通信的加密等。这有助于防范中间人攻击和保护通信的机密性。

**服务器身份验证是通过用户的knowshost文件实现的吗**

不是的，服务器身份验证不是通过用户的 `known_hosts`​ 文件来实现的。服务器身份验证是通过服务器的公钥进行的。

在SSH连接的过程中，服务器会在握手阶段向客户端发送它的公钥。客户端会将服务器的公钥存储在本地的 `known_hosts`​ 文件中。下次连接到同一台服务器时，客户端会检查 `known_hosts`​ 文件，验证服务器的公钥是否匹配。

这个验证的过程是为了确保客户端连接的确实是目标服务器，而不是一个中间人攻击。如果服务器的公钥发生了变化，客户端会收到警告，因为这可能表示连接到了一个不同的服务器或有安全风险。

​`known_hosts`​ 文件的作用是记录已知的主机的公钥，以便在下次连接时进行验证。它是一个本地存储的安全机制，用于确保连接的目标主机是已知并且是可信的。

**如何编写SSH免密登录脚本，包括如何发送公钥**

SSH免密登录通常涉及使用公钥认证。以下是一个简单的脚本，它包含了生成 SSH 密钥对、将公钥发送到远程服务器以及配置免密登录的步骤。请注意，这只是一个示例，实际情况可能因系统和需求而异。

**步骤 1: 生成 SSH 密钥对**

首先，你需要在本地机器上生成 SSH 密钥对。如果已经有密钥对，可以跳过这一步。

```bash
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

按照提示提供信息，这将生成一个密钥对，包括私钥（`~/.ssh/id_rsa`​）和公钥（`~/.ssh/id_rsa.pub`​）。

**步骤 2: 将公钥发送到远程服务器**

使用以下脚本将本地的公钥发送到远程服务器。替换 `user`​ 和 `hostname`​ 为你的用户名和远程服务器地址。

```bash
#!/bin/bash

USER="your_username"
HOST="your_remote_host"

# Copy public key to remote server
ssh-copy-id $USER@$HOST
```

运行这个脚本后，你将被要求输入远程服务器的密码。一旦验证成功，你的公钥将会添加到远程服务器的 `~/.ssh/authorized_keys`​ 文件中。

**步骤 3: 配置免密登录**

现在你应该能够通过 SSH 免密登录到远程服务器。测试一下：

```bash
ssh $USER@$HOST
```

如果一切设置正确，你将不再需要输入密码，直接登录到服务器。

请注意，这只是一个简单的示例。在实际生产环境中，请确保采用安全的做法，如限制 SSH 服务的配置，保护私钥等。此外，ssh-copy-id 在一些系统上可能不可用，你也可以手动将本地公钥内容添加到远程服务器的 `authorized_keys`​ 文件中。

## 初始化SSH

初始化 SSH 通常涉及生成 SSH 密钥对、设置配置文件等步骤。以下是一个简单的步骤指南，以帮助您初始化 SSH：

1. **检查是否已存在 SSH 密钥对：**

    首先，检查您计算机上是否已存在 SSH 密钥对。默认情况下，它们通常存储在 `~/.ssh/`​ 目录下。您可以使用以下命令检查：

    ```bash
    ls ~/.ssh
    ```

    如果您看到类似 `id_rsa`​ 和 `id_rsa.pub`​ 的文件，那么密钥对已存在。
2. **生成 SSH 密钥对：**

    如果您没有 SSH 密钥对或想要生成新的密钥对，可以使用以下命令：

    ```bash
    ssh-keygen -t rsa -b 2048 -C "your_email@example.com"
    ```

    这会生成一个 2048 位的 RSA 密钥对，并将公钥保存在 `~/.ssh/id_rsa.pub`​，私钥保存在 `~/.ssh/id_rsa`​。

    在 `-C`​ 选项后面，您可以添加一个注释，通常是您的电子邮件地址，以标识密钥的用途。
3. **添加公钥到 SSH 代理（可选）：**

    如果您想要使用 SSH 代理，可以将生成的私钥添加到代理中：

    ```bash
    ssh-add ~/.ssh/id_rsa
    ```

    这样，代理会在您登录时使用私钥，而无需每次都输入密码。
4. **将公钥添加到远程主机：**

    如果您计划通过 SSH 登录到远程主机，需要将您的公钥添加到目标主机上的 `authorized_keys`​ 文件。您可以使用 `ssh-copy-id`​ 命令，如前面的例子所示，或者手动将公钥内容添加到远程主机上的 `~/.ssh/authorized_keys`​ 文件中。
5. **测试 SSH 连接：**

    使用以下命令测试您的 SSH 连接：

    ```bash
    ssh username@remote_host
    ```

    替换 "username" 为您的远程用户名，"remote_host" 为您的远程主机地址。如果一切设置正确，您应该能够通过 SSH 登录而无需密码。

请注意，这只是一个基本的 SSH 初始化过程，具体的步骤可能因操作系统和具体需求而有所不同。确保您在执行此类操作时理解相应命令的含义，以免造成不必要的问题。

## SSH命令

### ssh-keygen

eg：`ssh-keygen -t rsa -b 2048 -C "your_email@example.com"`​

​`ssh-keygen`​ 是一个用于生成 SSH 密钥对的命令。下面是 `ssh-keygen`​ 命令中用到的参数的解释：

* ​`-t rsa`​: 指定生成密钥对的算法类型，这里是 RSA 算法。
* ​`-b 2048`​: 指定生成密钥的位数。在这个例子中，2048 位是默认的 RSA 密钥长度，提供了合理的安全性。
* ​`-C "your_email@example.com"`​: 添加注释，一般用来标识密钥的用途或相关信息。在这里，注释是您的电子邮件地址。

具体到您提到的 `-t -b`​，这可能是一个误解，因为 `-t`​ 和 `-b`​ 后面应该分别跟随特定的算法和位数参数。如果有其他特殊情况或更复杂的参数，可能需要查看您系统上的 `ssh-keygen`​ 文档或使用命令的帮助选项（`ssh-keygen --help`​）来获取详细信息。

总结一下：

* ​`-t`​: 指定密钥生成算法类型。
* ​`-b`​: 指定密钥的位数。
* ​`-C`​: 添加注释，用于标识密钥。

在使用这些参数时，您可以根据自己的需求调整算法、位数和注释。

### ssh-copy-id

eg：`ssh-copy-id username@remote_host`​

​`ssh-copy-id username@remote_host`​ 用于将本地计算机上的公钥添加到远程主机的 `authorized_keys`​ 文件中，以实现无密码的 SSH 登录。

这个命令会将您本地 `~/.ssh/id_rsa.pub`​ 或其他指定公钥文件的内容添加到远程主机上的 `~/.ssh/authorized_keys`​ 文件中。在执行该命令之前，确保您已经生成了 SSH 密钥对，其中私钥位于 `~/.ssh/id_rsa`​，而公钥则在 `~/.ssh/id_rsa.pub`​。

例如，如果您的用户名是 "username"，远程主机是 "remote_host"，您可以运行：

```bash
ssh-copy-id username@remote_host
```

系统将提示您输入远程主机的密码，然后将您的公钥添加到远程主机的 `authorized_keys`​ 文件中，使您能够通过 SSH 在不需要密码的情况下登录。

### ssh-add

eg：`ssh-add ~/.ssh/id_rsa`​

​`ssh-add`​ 命令用于将私钥添加到 SSH 认证代理（authentication agent）。SSH 代理是一个程序，负责保存私钥，使您可以在不用每次输入密码的情况下使用私钥进行身份验证。

当您运行：

```bash
ssh-add ~/.ssh/id_rsa
```

您正在将位于 `~/.ssh/id_rsa`​ 的私钥添加到 SSH 代理。这意味着代理将意识到这个私钥，并可以使用它来与具有相应公钥的远程服务器进行身份验证。

运行 `ssh-add`​ 命令后，您可能需要输入您的密码短语（如果您在创建 SSH 密钥时设置了一个）。一旦添加到代理，您就可以在该会话期间使用私钥进行身份验证，而无需每次都输入密码短语。

这在您有**多个 SSH 密钥**并希望通过 SSH 代理集中**管理**它们时特别有用。如果 `ssh-add`​​ 命令执行成功，您应该能够在该会话期间使用您的 SSH 密钥进行免密码身份验证。

> ssh-add只在会话期间有效吗

​`ssh-add`​ 命令添加的密钥通常只在当前登录会话期间有效。一旦您注销或关闭终端窗口，代理会话将结束，添加的密钥也会从代理中移除。

如果您希望使 SSH 密钥在系统重新启动后仍然保持有效，您可以考虑将 `ssh-add`​ 命令添加到您的 shell 配置文件中，例如 `~/.bashrc`​ 或 `~/.zshrc`​，这样每次登录时都会执行。

以下是一个在 Bash shell 下将 `ssh-add`​ 添加到 `~/.bashrc`​ 文件的例子：

```bash
echo 'eval "$(ssh-agent -s)"' >> ~/.bashrc
echo 'ssh-add ~/.ssh/id_rsa' >> ~/.bashrc
```

然后，您可以执行 `source ~/.bashrc`​ 使更改立即生效，或者重新启动终端窗口。

请注意，使用代理并在配置文件中自动添加密钥时，确保谨慎处理密钥，并避免将其添加到公共计算机或未经授权的环境中。

**SSH代理的主要目的是免去在每次使用SSH密钥连接到目标机器时都要输入密钥密码的麻烦。这主要涉及到本地机器的密钥，而不是目标机器的密码。综合来说，SSH代理的主要作用是优化在本地机器上使用SSH密钥的体验，而与目标机器上的密码验证没有直接关系。**

### sshpass

eg：`sshpass -p 'your_password' ssh user@hostname`​

​`sshpass`​ 是一个在非交互方式下为 `ssh`​ 命令提供密码的 Linux 实用工具。它通常用于脚本或自动化任务中，其中手动输入密码是不可行或不安全的。

​`sshpass`​ 的基本语法如下：

```bash
sshpass -p 'your_password' ssh user@hostname
```

在这里，`-p`​ 用于指定密码，然后使用指定的用户名（`user`​）和主机名（`hostname`​）调用 `ssh`​ 命令。

需要注意的是，在脚本中使用 `sshpass`​ 并在其中明文写入密码并不是最安全的做法，因为它会在进程列表中暴露密码并存在安全风险。在更安全的环境中，建议使用基于密钥的 SSH 验证，这样就不需要使用密码，而且通常被认为更安全。
