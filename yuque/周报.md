# 周报
## 2023.6.5
**周一**

搭建开发环境

**周二**

上午拉代码，调试项目。下午了解业务流转，大致了解项目运转模式，门户网站，CRM，航空公司

爬取网络请求，验证是否可退税（只有no show的客户可以退税），需要pnr和姓氏爬取网站请求，然后回退费接口。pnr就是定座记录编码，航司生成的唯一标识。

**周三**

抓取网络请求,	获取`book.goindigo.in`站点的 `/Booking/ViewAEM`和 `/Booking/RetrieveAEM`请求并解析，筛选并检测退税单是否可退。

```plain
// 主要属性 root   >   indigoTaxRefund

"indigoTaxRefund": {
	"errorInNoShowTaxRefund": "RefundFeeAlreadyAvailableAG",
	"fopType": "AG",
	"isRefundProcessed": false,
	// 是否去展示退税
	"isToShowTaxRefund": true,
	"refundAmount": 0,
	"response": false,
	"taxQueueFlag": false
},

"indigoTaxRefund": {
	"errorInNoShowTaxRefund": "",
	"fopType": "AG",
	"isRefundProcessed": false,
	"isToShowTaxRefund": false,
	"refundAmount": 0,
	"response": false,
	"taxQueueFlag": false
},
```

明天写退税代码，抽象成静态方法运行。

**周四**

测试退税检测，根据postman和fiddler解决因参数错误引起的POST请求302自动发起GET请求的问题。调试接口通过。

开始分析退税的数据包。

**周五**

上午解析申请提交退税的接口数据，下午梳理退税判断逻辑，整体流程测试通过，重新整理代码结构，将官网扫描流程与提交退税流程分离，整体检测提交退税流程调试通过。

## 2023.6.12
**周一**

1. 按照退款的代码规范改造6E的申请退税扫描，以及提交退税申请，具体根据策略模式和简单工厂模式规范各个航司的退款策略。
2. 初步理解TR航司退税的业务操作流程以及接口逻辑

**周二**

1. 根据需求文档的操作流程，抓取TR官网申请退税流程的数据包，整理并分析网络请求顺序、逻辑、参数，开始使用Postman调试接口。
2. 根据抓包请求顺序测试，发现postman或者curl访问失败，浏览器可以访问。根据测试方法测试申请主页，发现TR官网禁用userAgent非浏览器的请求，然后根据测试方法可以走通TR退税接口，整理排查此次问题的接口，开始编写代码。

**周三**

1. 排查6E多航段多乘客具体退税的情况，确认退税接口一次性全部申请退税，重新确认6E扫描接口的返回报文
2. 重构6E退税扫描代码，根据上午定的报文结构重新抓包分析返回数据结构，具体到某某航班某某乘客是否乘机，根据分析的数据结构建模，整理代码。

**周四**

1. 根据TR官网的申请退税抓包分析接口顺序、结构、报文，开发TR过期退税申请
2. 完善TR过期申请退税接口代码，并调试通过。根据测试订单测试成功，可以获取到申请的案例号。

**周五**

1. 根据DY过期退税的流程文档梳理DY过期退税的扫描和申请流程
2. 使用Fiddler分析抓到的退税扫描的数据包报文结构，确定` /resourceipr/api/mynorwegian/reservationDetails`接口可以获取到所需字段、是否可以退税的判断条件。
3. 下周主要进行DY退税扫描，退税申请的抓包，退税申请的代码开发工作。

## 2023.6.19
**周一**

1. DY扫描退税抓包，整理抓包的接口顺序，数据结构，接口的逻辑。
2. 调试接口是否访问成功，遇到 401禁止访问的问题，排查请求头中的`ApiRequestVerificationToken`字段，然后新写流程重新抓包去获取token。然后遇到在编解码方式一致的前提下，解析dom时的乱码问题，怀疑是压缩的问题，最后去除br的压缩源码，解决乱码。然后接口测试成功。明天写dy扫描的代码，并整合TR的扫描接口

**周二**

1. 总结一下调试接口遇到的问题，缺一个指定UK的参数导致同一接口返回报文不一致，排查是那威语言，添加参数`marketCode`=UK；
2. DY过期退税扫描开发并调试完成，整合进新的退税代码流程。
3. 开始整合之前的TR的API扫描代码，包括数据同步到syn_pnr表，筛选待扫描的数据，扫描退税接口。
4. 计划明天先完成DY退税的流程，再整合TR的扫描退税流程

**周三**

1. DY退税申请的官网界面更新后增加了邮箱验证码，等待运营回复。暂时搁置DY申请退税的流程开发，开始整合TR的API扫描
2. TRAPI接口扫描整合程度完成百分之80，主要包括过期捞数据重新梳理，捞取时间段跟业务确认，数据同步到pnr_scan的代码梳理，调用API的扫描及返回报文重新解析等，目前还缺少测试，以及一些代码细节的完善。

## 2023.6.25
**周日**

1. TR退税扫描的代码细节整合完成，测试环境缺少测试数据，先提交由其他同事测试。
2. 修改TR提交申请退税时的邮箱和性别参数是否固定值问题，DY提申请退税的邮箱验证码流程无法规避，暂时联系业务。
3. 目前只缺少DY提申请退税的流程开发，TR的扫描和申请，DY的扫描均已提交测试。

**周一**

1. 根据资料进一步熟悉Fiddler，以及代理，HTTPS通信原理
2. 明天计划了解航司的抓包流程。

**周二**

1. https://flyairseoul.com/I/CH/viewAvail.do查询航班数据抓包，解析出获取数据的核心接口/I/CH/searchFlightInfo.do，解析两个请求参数，一个是输入的json报文，另一个gubun在详情页的js代码中内嵌（后来发现该值为固定值，刷新页面后该值不变，但不确定是否永久是固定值）。然后解析详情页viewAvail.do的请求参数，请求为json，主要分析cookie。cookie值共变化三次，打开页面时获取到一个cookie值，key为__cf_bm，进行人机验证，人机验证后cookie进行替换，刷新url，重新颁发了一个cookie，第三次刷新的时机是页面加载完毕，然后依次梳理其他的cookie的value的变换过程。
2. 整个cookie的变化流程大致请求https://flyairseoul.com/CW/ch/main.do，如果没带**cf_bm，服务端会设置一个cookie，失效时间大约为30分钟，并进行cloudflare的检查。人机识别点击确认后，会重新访问该地址且**cf_bm会刷新值；待页面加载完毕，会进行第二次替换**cf_bm。后续请求**cf_bm的值不变
3. 目前请求数据遇到的问题基本处于cookie的验证获取阶段。

**周三**

1. 排除google analysis相关的ga开头以及IBM提供的自然语言相关的wcs的cookie，主要针对`__cf_bm`，`cf_clearance`，`cf_chl_2`相关的cloudflare的cookie。
2. cookie的__cf_bm失效或不存在，都会触发cloudflare验证。根据浏览器调试工具，获取cloudflare相关的js文件，分析相关的代码。

**周四**

1. 由于主要请求含有很多类型的cookie并且每个失效时间也不相同，确定只需要一个 cf_clearance 的cookie就可以获取搜索的数据，有效期为30分钟，失效后需要重新进行人机验证，排除其他cookie的影响，同时确定请求的其中一个参数gubun与ip地址有关，该值由服务器返回到页面的js代码中，如果ip更换的话，需要每次先访问 /viewAvail.do 获取gubun的值，另一个参数hidBookConditionData是 json对象进行了url编码。问题的关键在于 cf_clearance 的获取。同时经过测试只要获取到 cf_clearance的cookie值就可以获取到数据，但是如果频率太高可能会封ip。
2. cf_clearance的获取需要js逆向解密 cloudflare 返回的加密 js，大致共6次与cloudflare的交互，目前的主要难点是 js 逆向模拟与cloudflare的交互。计划结合一些教程以及cloudflare的分析去尝试解析。

**周五**

1. 浏览器debug cloudflare的加密过程，包括通过动态的js计算出请求的url和参数，js去收集当时浏览器的环境参数。正在寻找加密的步骤算法。
2. 有一些问题就是如果不开代理，cloudflare就直接会自动通过验证，不需要点击。如果开了网络代理，就需要点击是否人机。问题是不开代理的话数据包很难捕获到。然后js代码是混淆过的，变量方法都是单字母数组命名，易读性很差。目前没找到好用的反混淆工具。

## 2023/7/3
**周一**

1. 根据xhr断点调试https://challenges.cloudflare.com/cdn-cgi/challenge-platform/h/g/orchestrate/chl_api/v1?ray={rayKey} 返回的JS。参考https://www.resourch.com/archives/19.html

‍

## 2023/7/17
1. 通过JavaFX WebView 测试https://flyairseoul.com的cloudflare，人机验证失败，会一直进入验证状态。根据JavaFx WebView文档以及相关资料配置参数包括ua，页面大小仍然验证失败。目前WebView方式只能配置一些简单浏览器参数，测试后仍验证失败。
2. 通过其他方法 JxBrowser，SWT Browser 测试，依赖项下载超时，切换外网仍然超时。目前仍在测试其他方案。
3. 配置Node.js 运行southwest的测试代码。通过MDN查阅JS资料去阅读southwest的代码。

‍

